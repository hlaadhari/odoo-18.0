<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Assets pour le module STEG -->
    <template id="assets_backend" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <link rel="stylesheet" type="text/css" href="/steg_stock_management/static/src/css/steg_style.css"/>
            <script type="text/javascript" src="/steg_stock_management/static/src/js/steg_dashboard.js"/>
        </xpath>
    </template>

    <!-- Template pour le dashboard -->
    <template id="Dashboard" name="STEG Dashboard">
        <div class="steg-dashboard">
            <!-- Header STEG -->
            <div class="steg-header">
                <div class="row">
                    <div class="col-md-8">
                        <h1>Tableau de Bord STEG</h1>
                        <p>Gestion des Stocks - Pièces de Rechange</p>
                    </div>
                    <div class="col-md-4 text-right">
                        <img src="/steg_stock_management/static/img/steg_logo.png" alt="STEG" class="steg-logo"/>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div t-if="state.loading" class="text-center">
                <div class="steg-spinner"></div>
                <p>Chargement des données...</p>
            </div>

            <!-- Error -->
            <div t-if="state.error" class="steg-notification steg-notification-error">
                <strong>Erreur:</strong> <t t-esc="state.error"/>
            </div>

            <!-- Dashboard content -->
            <div t-if="!state.loading and !state.error">
                <!-- Statistiques principales -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="steg-dashboard-card" t-on-click="openProductsView">
                            <div class="steg-stat-box">
                                <div>
                                    <div class="steg-stat-number" t-esc="state.stats.totalProducts"/>
                                    <div class="steg-stat-label">Pièces de Rechange</div>
                                </div>
                                <i class="fa fa-cogs fa-2x text-primary"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="steg-dashboard-card">
                            <div class="steg-stat-box">
                                <div>
                                    <div class="steg-stat-number" t-esc="state.stats.totalLocations"/>
                                    <div class="steg-stat-label">Emplacements</div>
                                </div>
                                <i class="fa fa-map-marker fa-2x text-info"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="steg-dashboard-card" t-on-click="openPendingValidations">
                            <div class="steg-stat-box">
                                <div>
                                    <div class="steg-stat-number steg-urgency-medium" t-esc="state.stats.pendingPickings"/>
                                    <div class="steg-stat-label">En Attente de Validation</div>
                                </div>
                                <i class="fa fa-clock-o fa-2x text-warning"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="steg-dashboard-card" t-on-click="openLowStockProducts">
                            <div class="steg-stat-box">
                                <div>
                                    <div class="steg-stat-number steg-urgency-high" t-esc="state.stats.lowStockProducts"/>
                                    <div class="steg-stat-label">Stock Bas</div>
                                </div>
                                <i class="fa fa-exclamation-triangle fa-2x text-danger"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques par division -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="steg-dashboard-card">
                            <h3>Statistiques par Division</h3>
                            <div class="row">
                                <div t-foreach="Object.keys(state.stats.divisions)" t-as="divisionCode" t-key="divisionCode" class="col-md-3">
                                    <div t-attf-class="steg-dashboard-card #{getDivisionClass(divisionCode)}" t-on-click="() => this.openDivisionProducts(divisionCode)">
                                        <h4 t-esc="state.stats.divisions[divisionCode].name"/>
                                        <div class="steg-stat-box">
                                            <div>
                                                <div class="steg-stat-number" t-esc="state.stats.divisions[divisionCode].products"/>
                                                <div class="steg-stat-label">Pièces</div>
                                            </div>
                                        </div>
                                        <div class="steg-stat-box">
                                            <div>
                                                <div class="steg-stat-number" t-esc="state.stats.divisions[divisionCode].pickings"/>
                                                <div class="steg-stat-label">Mouvements</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mouvements récents -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="steg-dashboard-card">
                            <h3>Mouvements Récents</h3>
                            <table class="table table-steg">
                                <thead>
                                    <tr>
                                        <th>Référence</th>
                                        <th>Numéro STEG</th>
                                        <th>Division</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="state.stats.recentMovements" t-as="movement" t-key="movement.id">
                                        <td t-esc="movement.name"/>
                                        <td t-esc="movement.steg_request_number"/>
                                        <td t-esc="movement.steg_division_id and movement.steg_division_id[1]"/>
                                        <td t-esc="formatDate(movement.create_date)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</odoo>